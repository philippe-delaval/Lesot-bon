<script setup lang="ts">
import { ref, computed } from 'vue';
import { Head, Link, router } from '@inertiajs/vue3';
import { Plus, Filter, Search } from 'lucide-vue-next';
import { 
  type Demande, 
  type DemandeFilters, 
  type DemandeStats
} from '@/types/index.d';
import AppLayout from '@/layouts/AppLayout.vue';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import DemandeCard from '@/components/Demandes/DemandeCard.vue';
import Heading from '@/components/Heading.vue';

interface Props {
  demandes: {
    data: Demande[];
    links: any[];
    meta: any;
  };
  filters: DemandeFilters;
  stats: DemandeStats;
}

const props = defineProps<Props>();

const filters = ref<DemandeFilters>({
  role: props.filters.role || 'all',
  statut: props.filters.statut || 'all',
  priorite: props.filters.priorite || 'all',
  search: props.filters.search || '',
});

const applyFilters = () => {
  router.get(route('demandes.index'), filters.value, {
    preserveState: true,
    replace: true,
  });
};

const resetFilters = () => {
  filters.value = {
    role: 'all',
    statut: 'all',
    priorite: 'all',
    search: '',
  };
  applyFilters();
};

// Navigation vers la page de cr√©ation
const creerNouvelleDemande = () => {
  router.visit(route('demandes.create'));
};

const breadcrumbs = [
  { title: 'Dashboard', href: route('dashboard') },
  { title: 'Demandes', href: route('demandes.index') },
];

const statsCards = computed(() => [
  {
    title: 'En attente',
    value: props.stats.en_attente,
    description: 'Demandes non assign√©es',
    color: 'text-yellow-600',
  },
  {
    title: 'Mes assign√©es',
    value: props.stats.assignees,
    description: 'Demandes qui me sont assign√©es',
    color: 'text-blue-600',
  },
  {
    title: 'Mes cr√©√©es',
    value: props.stats.mes_creees,
    description: 'Demandes que j\'ai cr√©√©es',
    color: 'text-green-600',
  },
]);
</script>

<template>
  <Head title="Demandes en cours" />

  <AppLayout :breadcrumbs="breadcrumbs">
    <!-- Container responsive avec marges mobile-first -->
    <div class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8 xl:px-12 py-4 md:py-6 lg:py-8">
      <div class="space-y-4 md:space-y-6 lg:space-y-8">
        <!-- Header responsive -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <Heading title="Demandes en cours">
            <template #description>
              G√©rez les demandes d'intervention et suivez leur progression
            </template>
          </Heading>

          <div class="flex gap-2">
            <Button @click="creerNouvelleDemande" class="w-full sm:w-auto gap-2">
              <Plus class="h-4 w-4" />
              Nouvelle demande
            </Button>
          </div>
        </div>

        <!-- Stats Cards responsive -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 lg:gap-6">
        <Card v-for="stat in statsCards" :key="stat.title">
          <CardHeader class="pb-2">
            <CardTitle class="text-sm font-medium text-muted-foreground">
              {{ stat.title }}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div :class="['text-2xl font-bold', stat.color]">
              {{ stat.value }}
            </div>
            <p class="text-xs text-muted-foreground mt-1">
              {{ stat.description }}
            </p>
          </CardContent>
        </Card>
      </div>

        <!-- Filtres responsive -->
        <Card>
          <CardHeader>
            <CardTitle class="flex items-center gap-2">
              <Filter class="h-4 w-4" />
              Filtres
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
            <div class="space-y-2">
              <label class="text-sm font-medium">Recherche</label>
              <div class="relative">
                <Search class="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                <Input
                  v-model="filters.search"
                  placeholder="Rechercher..."
                  class="pl-8"
                  @keyup.enter="applyFilters"
                />
              </div>
            </div>

            <div class="space-y-2">
              <label class="text-sm font-medium">R√¥le</label>
              <select 
                v-model="filters.role" 
                @change="applyFilters"
                class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
              >
                <option value="all">Toutes mes demandes</option>
                <option value="creees">Mes demandes cr√©√©es</option>
                <option value="assignees">Mes demandes assign√©es</option>
              </select>
            </div>

            <div class="space-y-2">
              <label class="text-sm font-medium">Statut</label>
              <select 
                v-model="filters.statut" 
                @change="applyFilters"
                class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
              >
                <option value="all">Tous les statuts</option>
                <option value="en_attente">En attente</option>
                <option value="assignee">Assign√©e</option>
                <option value="en_cours">En cours</option>
                <option value="terminee">Termin√©e</option>
                <option value="annulee">Annul√©e</option>
              </select>
            </div>

            <div class="space-y-2">
              <label class="text-sm font-medium">Priorit√©</label>
              <select 
                v-model="filters.priorite" 
                @change="applyFilters"
                class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
              >
                <option value="all">Toutes les priorit√©s</option>
                <option value="urgente">Urgente</option>
                <option value="haute">Haute</option>
                <option value="normale">Normale</option>
              </select>
            </div>
          </div>

            <div class="flex flex-col sm:flex-row sm:justify-end gap-2 mt-4">
              <Button variant="outline" @click="resetFilters" class="w-full sm:w-auto">
                R√©initialiser
              </Button>
              <Button @click="applyFilters" class="w-full sm:w-auto">
                Appliquer
              </Button>
            </div>
        </CardContent>
      </Card>

        <!-- Liste des demandes responsive -->
        <div v-if="demandes.data.length > 0" class="space-y-4">
          <div class="grid grid-cols-1 gap-3 md:gap-4 lg:gap-6">
          <DemandeCard 
            v-for="demande in demandes.data" 
            :key="demande.id"
            :demande="demande"
          />
          </div>

          <!-- Pagination responsive -->
          <div v-if="demandes.meta.total > demandes.meta.per_page" class="flex justify-center">
          <nav class="flex items-center gap-2">
            <template v-for="link in demandes.links" :key="link.url">
              <Link
                v-if="link.url"
                :href="link.url"
                :class="[
                  'px-3 py-2 text-sm rounded-md transition-colors',
                  link.active 
                    ? 'bg-blue-600 text-white' 
                    : 'text-gray-700 hover:bg-gray-100'
                ]"
                v-html="link.label"
              />
              <span
                v-else
                class="px-3 py-2 text-sm text-gray-400"
                v-html="link.label"
              />
            </template>
          </nav>
          </div>
        </div>

        <!-- Empty State responsive -->
        <Card v-else class="text-center py-8 md:py-12">
        <CardContent>
          <div class="space-y-4">
            <div class="text-4xl text-gray-300">üìã</div>
            <div>
              <h3 class="text-lg font-medium text-gray-900">
                Aucune demande trouv√©e
              </h3>
              <p class="text-gray-500 mt-1">
                Cr√©ez votre premi√®re demande d'intervention pour commencer.
              </p>
            </div>
              <Button @click="creerNouvelleDemande" class="w-full sm:w-auto gap-2">
                <Plus class="h-4 w-4" />
                Cr√©er une demande
              </Button>
          </div>
          </CardContent>
        </Card>
      </div>
    </div>
  </AppLayout>
</template>